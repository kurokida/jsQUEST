<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type"  content="text/html; charset=UTF-8">  
    <script src="./jspsych.js"></script>
    <script src="./jspsych-html-button-response.js"></script>
    <script src="./jspsych-html-keyboard-response.js"></script>
    <script src="./jspsych-survey-text.js"></script>
    <script src="./platform.js"></script>
    <script src="./jsQuestPlus.js"></script>
    <script src="./numeric.js"></script>
    <link rel="stylesheet" href="./jspsych.css">
    <style>
        .jspsych-display-element {
            display: inline;
        }
        div.instruction {
            width: 600px;
            text-align: left;
        }
    </style>

  </head>
  <body></body>
  <script>
    let trial_num = 0
    let base_time

    function func_resp0(freq, contrast, threshold, c0, cf){
        const max = Math.max(threshold, c0 + cf*freq)
        return jsquest.weibull(contrast, max, 3, 0.5, 0.01)
    }

    // Psychometric function corresponding to the second response (response = 1).
    function func_resp1(freq, contrast, threshold, c0, cf){
        return 1 - func_resp0(freq, contrast, threshold, c0, cf) 
    }

    const spatial_frequency = jsquest.getArray_with_fix_interval(0, 2, 40)
    const contrast = jsquest.getArray_with_fix_interval(-50, 2, 0)
    const threshold = jsquest.getArray_with_fix_interval(-50, 2, -30)
    const c0 = jsquest.getArray_with_fix_interval(-60, 2, -40)
    const cf = jsquest.getArray_with_fix_interval(0.8, 0.2, 1.6)

    base_time = performance.now();
    // jsqp means jsQuestPlus. You can use any variable name you like.
    const jsqp = new jsquest([func_resp0, func_resp1], [spatial_frequency, contrast], [threshold, c0, cf])
    const init_num = performance.now() - base_time

    base_time = performance.now();    
    const intensity = jsqp.getStimParams()
    const getStimParams_time = performance.now() - base_time

    base_time = performance.now();
    jsqp.update(intensity, 1)
    const update_time = performance.now() - base_time


    const instruction = {
        type: 'html-button-response',
        stimulus: `<div class="instruction"><p>この度、私（黒木）は心理物理学のオンライン実験において閾値を測定するためのツール（jsQUEST）を開発しました。</p>
            <p>本調査は、みなさんのパソコンで問題なくjsQUESTが機能するかを確認するためのものです。</p>
            <p>みなさんのほうで何かを回答していただく必要はありませんが、みなさんが現在お使いの機種、OS（WindowsやMacなど）、ウェブブラウザ（Edge, Safari, Chromeなど）の情報を記録させていただきます。</p>
            <p>個人が特定されるような情報を取得することはなく、例えば「WindowsのChromeで、jsQUESTが何秒で動作した」というような情報が記録されます。また記録した情報を集計して論文等で発表する予定です。</p>
            <p>何かがインストールされるということもありません。</p>
            <p>調査への協力に同意をいただける場合には「次へ」のボタンを押してください。</p></div>`,
        choices: ['次へ'],
    }


    const briefing = {
        type: 'html-button-response',
        stimulus: `<div class="instruction"><p>調査は終了しました。ご協力いただき本当にありがとうございました。</p>
            <p>ウィンドウを閉じていただいて大丈夫です。</p>
            <p>もしjsQUESTに関心のあるかたは、<a href="https://kurokida.github.io/jsQUEST/">こちら</a>をご覧ください。</p>
            </div>`,
        on_start: function(trial){
            const myrandID = jsPsych.randomization.randomID(8);
    
            jsPsych.data.addProperties({
                date: getDateStr(),
                ID: myrandID,
                appName: navigator.appName,
                vendor: navigator.vendor,
                platform: navigator.platform,
                userAgent: navigator.userAgent,
                platform_name: platform.name,
                platform_version: platform.version,
                platform_layout: platform.layout,
                architecture: platform.os.architecture,
                family: platform.os.family,
                os_version: platform.os.version,
                os: platform.os.toString(),
                description: platform.description,
                product: platform.product,
                init_num: init_num,
                getStimParams_time: getStimParams_time,
                update_time: update_time
            })

            saveData()
            
        },
        choices: ['Finish']
    }

    function saveData() {
        var xhr = new XMLHttpRequest();
        // xhr.open('POST', 'write_data.php'); // change 'write_data.php' to point to php script.
        xhr.open('POST', 'jsqp_write_data.php', false); // Need to specify false to save data with iPhone or iPad
        // https://github.com/jspsych/jsPsych/issues/1999#issuecomment-883748620

        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function() {
            if(xhr.status == 200){
                var response = JSON.parse(xhr.responseText);
                console.log(response.success);
            }
        };
        xhr.onerror = function(){
            alert('Err')
            alert(`Error ${xhr.status}: ${xhr.statusText}: ${xhr.responseXML}`); 
        }
        xhr.send(jsPsych.data.get().json());
    }

    jsPsych.init({
        timeline: [instruction, briefing],
        on_finish: function(){
            // jsPsych.data.displayData(); 
        },
    });

    function getDateStr(){
        const now = new Date();
        const year = now.getFullYear();
        let month = now.getMonth() + 1; // 月
        let day = now.getDate(); // 日
        let hour = now.getHours(); // 時
        let minute = now.getMinutes(); // 分
        let sec = now.getSeconds(); // 秒
        // 数値が1桁の場合、頭に0を付けて2桁で表示する指定
        if(month < 10) { month = "0" + month; }
        if(day < 10) { day = "0" + day; }
        if(hour < 10) { hour = "0" + hour; }
        if(minute < 10) { minute = "0" + minute; }
        if(sec < 10) { sec = "0" + sec; }

        return year + '-' + month + '-' + day + '-' + hour + ':' + minute + ':' + sec;
    }
  </script>
</html>
