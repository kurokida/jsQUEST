<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type"  content="text/html; charset=UTF-8">  
    <script src="./jspsych.js"></script>
    <script src="./jspsych-html-button-response.js"></script>
    <script src="./jspsych-html-keyboard-response.js"></script>
    <script src="./jspsych-survey-text.js"></script>
    <script src="./platform.js"></script>
    <script src="./jsQuestPlus.js"></script>
    <script src="./numeric.js"></script>
    <link rel="stylesheet" href="./jspsych.css">
    <style>
        .jspsych-display-element {
            display: inline;
        }
        div.instruction {
            width: 600px;
            text-align: left;
        }
    </style>

  </head>
  <body></body>
  <script>
    function example1(){
            // Example: 1 stimulus parameter x 1 PF parameter x 2 responses
    
            output = {}
            output['func_resp0'] = function(stim, threshold, slope, guess, lapse) {
                return jsquest.weibull(stim, threshold, slope, guess, lapse) 
            }

            // Psychometric function corresponding to the second response (response = 1).
            output['func_resp1'] = function(stim, threshold, slope, guess, lapse) {
                return 1 - output.func_resp0(stim, threshold, slope, guess, lapse) 
            }

            const true_slope = 3.5
            const true_guess = 0.5
            const true_lapse = 0.02

            let stim_domain = numeric.linspace(-40, 0) // [-40, -39, -38, ..., -1, 0]
            let threshold_domain = numeric.linspace(-40,0) // [-40, -39, -38, ..., -1, 0]
            let slope_domain = [true_slope] // Don't forget to add brackets, i.e., specify as an array.
            let guess_domain = [true_guess]
            let lapse_domain = [true_lapse]

            const base_time = performance.now();
            // jsqp means jsQuestPlus. You can use any variable name you like.
            output['jsqp'] = new jsquest(
                [output.func_resp0, output.func_resp1], [stim_domain], [threshold_domain, slope_domain, guess_domain, lapse_domain])
            output['init_time'] = performance.now() - base_time

            return output

    }

    function example4(){
        output = {}
        output['func_resp0'] = function (freq, contrast, threshold, c0, cf){
            const max = Math.max(threshold, c0 + cf*freq)
            return jsquest.weibull(contrast, max, 3, 0.5, 0.01)
        }
        output['func_resp1'] = function (freq, contrast, threshold, c0, cf){
            return 1 - output.func_resp0(freq, contrast, threshold, c0, cf) 
        }

        const spatial_frequency = jsquest.getArray_with_fix_interval(0, 2, 40)
        const contrast = jsquest.getArray_with_fix_interval(-50, 2, 0)
        const threshold = jsquest.getArray_with_fix_interval(-50, 2, -30)
        const c0 = jsquest.getArray_with_fix_interval(-60, 2, -40)
        const cf = jsquest.getArray_with_fix_interval(0.8, 0.2, 1.6)

        const base_time = performance.now();
        // jsqp means jsQuestPlus. You can use any variable name you like.
        output['jsqp'] = new jsquest([output.func_resp0, output.func_resp1], [spatial_frequency, contrast], [threshold, c0, cf])
        output['init_time'] = performance.now() - base_time

        return output
    }

    function example5(){
        output = {}
        output['func_resp0'] = function (contrast, spatial_freq, temporal_freq, threshold, c0, cf, cw){
            const max = Math.max(threshold, c0 + cf*spatial_freq + cw*temporal_freq)
            return jsquest.weibull(contrast, max, 3, 0.5, 0.01)
        }
        output['func_resp1'] = function (contrast, spatial_freq, temporal_freq, threshold, c0, cf, cw){
            return 1 - output.func_resp0(contrast, spatial_freq, temporal_freq, threshold, c0, cf, cw)
        }

        const contrast = jsquest.getArray_with_fix_interval(-40, 5, 0)       
        const spatial_freq = jsquest.getArray_with_fix_interval(0, 5, 40)
        const temporal_freq = jsquest.getArray_with_fix_interval(0, 5, 40)
        const threshold = jsquest.getArray_with_fix_interval(-50, 5, -30)
        const c0 = jsquest.getArray_with_fix_interval(-60, 5, -40)
        const cf = jsquest.getArray_with_fix_interval(0.8, 0.2, 1.6)
        const cw = jsquest.getArray_with_fix_interval(0.8, 0.2, 1.6)

        const base_time = performance.now();
        // jsqp means jsQuestPlus. You can use any variable name you like.
        output['jsqp'] = new jsquest([output.func_resp0, output.func_resp1], [contrast, spatial_freq, temporal_freq], [threshold, c0, cf, cw])
        output['init_time'] = performance.now() - base_time

        return output
    }

    const ex1 = example1()

    const ex4 = example4()
    const ex5 = example5()
    // console.log(ex5)

    const simulation = []
    const instruction = {
        type: 'html-button-response',
        stimulus: `<div class="instruction"><p>この度、私（黒木）は心理物理学のオンライン実験において閾値を測定するためのツール（jsQUEST）を開発しました。</p>
            <p>本調査は、みなさんのパソコンで問題なくjsQUESTが機能するかを確認するためのものです。</p>
            <p>みなさんのほうで何かを回答していただく必要はありませんが、みなさんが現在お使いの機種、OS（WindowsやMacなど）、ウェブブラウザ（Edge, Safari, Chromeなど）の情報を記録させていただきます。</p>
            <p>個人が特定されるような情報を取得することはなく、例えば「WindowsのChromeで、jsQUESTが何秒で動作した」というような情報が記録されます。また記録した情報を集計して論文等で発表する予定です。</p>
            <p>何かがインストールされるということもありません。</p>
            <p>調査への協力に同意をいただける場合には「次へ」のボタンを押してください。</p></div>`,
        choices: ['次へ'],
    }

    simulation.push(instruction)

    // Ex1
    for (let i = 0; i < 32; i++){
        const trial = {
            type: 'html-keyboard-response',
            stimulus: function(){
                // const progress = Math.round(trial_num/simulated_answers.length * 100)
                const progress = 100
                return `<p>調査中です。30秒ほどで終わります。</p><p>画面が自動的に切り替わりますので、このままお待ちください。</p>
                    <p>調査の${progress}%が完了しました。</p>`},
            // stimulus: '<p>調査中です。30秒ほどで終わります。</p><p>画面が自動的に切り替わりますので、このままお待ちください。',
            choices: ['jsPsych.NO_KEYS'],
            data: {Trial: i+1},
            trial_duration: 100,
            on_finish(data){
                function simulate_observer(contrast){
                    const true_threshold = -20
                    const true_slope = 3.5
                    const true_guess = 0.5
                    const true_lapse = 0.02

                    if (Math.random() > ex1.func_resp0(contrast, true_threshold, true_slope, true_guess, true_lapse)){
                        return 1 // yes
                    } else {
                        return 0 // no
                    }
                }

                const base_time1 = performance.now();    
                const stim = ex1.jsqp.getStimParams()
                const getStimParams_time = performance.now() - base_time1

                const resp = simulate_observer(stim) 

                const base_time2 = performance.now();
                ex1.jsqp.update(stim, resp)
                const update_time = performance.now() - base_time2

                data['getStimParams_time'] = getStimParams_time
                data['update_time'] = update_time
                data['init_time'] = ex1.init_time
                data['samples'] = calc_samples(ex1)

                // console.log(trial_num)
            }
        }
        simulation.push(trial)
    }

    // Ex4
    for (let i = 0; i < 32; i++){
        const trial = {
            type: 'html-keyboard-response',
            stimulus: function(){
                // const progress = Math.round(trial_num/simulated_answers.length * 100)
                const progress = 100
                return `<p>調査中です。30秒ほどで終わります。</p><p>画面が自動的に切り替わりますので、このままお待ちください。</p>
                    <p>調査の${progress}%が完了しました。</p>`},
            // stimulus: '<p>調査中です。30秒ほどで終わります。</p><p>画面が自動的に切り替わりますので、このままお待ちください。',
            choices: ['jsPsych.NO_KEYS'],
            data: {Trial: i+1},
            trial_duration: 100,
            // on_start(trial){
                // trial.func_resp0 = function (freq, contrast, threshold, c0, cf){
                //     const max = Math.max(threshold, c0 + cf*freq)
                //     return jsquest.weibull(contrast, max, 3, 0.5, 0.01)
                // }
                // trial.func_resp1 = function (freq, contrast, threshold, c0, cf){
                //     return 1 - trial.func_resp0(freq, contrast, threshold, c0, cf) 
                // }

                // const spatial_frequency = jsquest.getArray_with_fix_interval(0, 2, 40)
                // const contrast = jsquest.getArray_with_fix_interval(-50, 2, 0)
                // const threshold = jsquest.getArray_with_fix_interval(-50, 2, -30)
                // const c0 = jsquest.getArray_with_fix_interval(-60, 2, -40)
                // const cf = jsquest.getArray_with_fix_interval(0.8, 0.2, 1.6)

                // const base_time = performance.now();
                // // jsqp means jsQuestPlus. You can use any variable name you like.
                // trial.jsqp = new jsquest([trial.func_resp0, trial.func_resp1], [spatial_frequency, contrast], [threshold, c0, cf])
                // trial.init_time = performance.now() - base_time

                // // return [jsqp, init_time]
            // },
            on_finish(data){
                function simulate_observer(freq, contrast){
                    const true_threshold = -35
                    const true_c0 = -50
                    const true_cf = 1.2

                    if (Math.random() > ex4.func_resp0(freq, contrast, true_threshold, true_c0, true_cf)){
                        return 1 // yes
                    } else {
                        return 0 // no
                    }
                }

                const base_time1 = performance.now();    
                const stim = ex4.jsqp.getStimParams()
                const getStimParams_time = performance.now() - base_time1

                const resp = simulate_observer(stim[0], stim[1]) 

                const base_time2 = performance.now();
                ex4.jsqp.update(stim, resp)
                const update_time = performance.now() - base_time2

                data['getStimParams_time'] = getStimParams_time
                data['update_time'] = update_time
                data['init_time'] = ex4.init_time
                data['samples'] = calc_samples(ex4)

                // console.log(trial_num)
            }
        }
        simulation.push(trial)
    }

    function calc_samples(expdata){
        return expdata.jsqp.comb_stim_params.length * expdata.jsqp.comb_PF_params.length * expdata.jsqp.responses.length
    }

    // Ex5
    for (let i = 0; i < 64; i++){
        const trial = {
            type: 'html-keyboard-response',
            stimulus: function(){
                // const progress = Math.round(trial_num/simulated_answers.length * 100)
                const progress = 100
                return `<p>調査中です。30秒ほどで終わります。</p><p>画面が自動的に切り替わりますので、このままお待ちください。</p>
                    <p>調査の${progress}%が完了しました。</p>`},
            // stimulus: '<p>調査中です。30秒ほどで終わります。</p><p>画面が自動的に切り替わりますので、このままお待ちください。',
            choices: ['jsPsych.NO_KEYS'],
            data: {Trial: i+1},
            trial_duration: 100,
            on_finish(data){
                function simulate_observer(contrast, spatial_freq, temporal_freq){
                    const true_threshold = -40
                    const true_c0 = -50
                    const true_cf = 1.2
                    const true_cw = 1.0

                    if (Math.random() > ex5.func_resp0(contrast, spatial_freq, temporal_freq, true_threshold, true_c0, true_cf, true_cw)){
                        return 1 // yes
                    } else {
                        return 0 // no
                    }
                }

                const base_time1 = performance.now();    
                const stim = ex5.jsqp.getStimParams()
                const getStimParams_time = performance.now() - base_time1

                const resp = simulate_observer(stim[0], stim[1], stim[2]) 

                const base_time2 = performance.now();
                ex5.jsqp.update(stim, resp)
                const update_time = performance.now() - base_time2

                data['getStimParams_time'] = getStimParams_time
                data['update_time'] = update_time
                data['init_time'] = ex5.init_time
                data['samples'] = calc_samples(ex5)
            }
        }
        simulation.push(trial)
    }



    const briefing = {
        type: 'html-button-response',
        stimulus: `<div class="instruction"><p>調査は終了しました。ご協力いただき本当にありがとうございました。</p>
            <p>ウィンドウを閉じていただいて大丈夫です。</p>
            <p>もしjsQUESTに関心のあるかたは、<a href="https://kurokida.github.io/jsQUEST/">こちら</a>をご覧ください。</p>
            </div>`,
        on_start: function(trial){
            const myrandID = jsPsych.randomization.randomID(8);
            const ex1_estimates = ex1.jsqp.getEstimates()
            const ex4_estimates = ex4.jsqp.getEstimates()
            const ex5_estimates = ex5.jsqp.getEstimates()

    
            jsPsych.data.addProperties({
                date: getDateStr(),
                ID: myrandID,
                appName: navigator.appName,
                vendor: navigator.vendor,
                platform: navigator.platform,
                userAgent: navigator.userAgent,
                platform_name: platform.name,
                platform_version: platform.version,
                platform_layout: platform.layout,
                architecture: platform.os.architecture,
                family: platform.os.family,
                os_version: platform.os.version,
                os: platform.os.toString(),
                description: platform.description,
                product: platform.product,
                // init_time: ex4.init_time,
                // ex4_samples: ex4.jsqp.comb_stim_params.length * ex4.jsqp.comb_PF_params.length * ex4.jsqp.responses.length,
                ex1_threshold: ex1_estimates[0],
                ex4_threshold: ex4_estimates[0],
                ex4_c0: ex4_estimates[1],
                ex4_cf: ex4_estimates[2],
                ex5_threshold: ex5_estimates[0],
                ex5_c0: ex5_estimates[1],
                ex5_cf: ex5_estimates[2],
                ex5_cw: ex5_estimates[3]
            })

            // saveData()
            jsPsych.data.get().ignore('stimulus').localSave('csv','mydata.csv');
        },
        choices: ['Finish']
    }
    simulation.push(briefing)

    function saveData() {
        var xhr = new XMLHttpRequest();
        // xhr.open('POST', 'write_data.php'); // change 'write_data.php' to point to php script.
        xhr.open('POST', 'jsqp_write_data.php', false); // Need to specify false to save data with iPhone or iPad
        // https://github.com/jspsych/jsPsych/issues/1999#issuecomment-883748620

        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function() {
            if(xhr.status == 200){
                var response = JSON.parse(xhr.responseText);
                console.log(response.success);
            }
        };
        xhr.onerror = function(){
            alert('Err')
            alert(`Error ${xhr.status}: ${xhr.statusText}: ${xhr.responseXML}`); 
        }
        xhr.send(jsPsych.data.get().json());
    }

    jsPsych.init({
        timeline: simulation,
        on_finish: function(){
            // jsPsych.data.displayData(); 
        },
    });

    function getDateStr(){
        const now = new Date();
        const year = now.getFullYear();
        let month = now.getMonth() + 1; // 月
        let day = now.getDate(); // 日
        let hour = now.getHours(); // 時
        let minute = now.getMinutes(); // 分
        let sec = now.getSeconds(); // 秒
        // 数値が1桁の場合、頭に0を付けて2桁で表示する指定
        if(month < 10) { month = "0" + month; }
        if(day < 10) { day = "0" + day; }
        if(hour < 10) { hour = "0" + hour; }
        if(minute < 10) { minute = "0" + minute; }
        if(sec < 10) { sec = "0" + sec; }

        return year + '-' + month + '-' + day + '-' + hour + ':' + minute + ':' + sec;
    }
  </script>
</html>
